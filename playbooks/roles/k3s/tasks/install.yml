---
- name: Ensure curl is installed
  ansible.builtin.apt:
    name: curl
    state: present
    update_cache: true
  become: true

- name: Ensure K3s config dir exists
  ansible.builtin.file:
    path: "{{ k3s_config_dir }}"
    state: directory
    mode: "0755"
  become: true

- name: Write K3s config.yaml
  ansible.builtin.copy:
    dest: "{{ k3s_config_dir }}/config.yaml"
    mode: "0644"
    content: |
      write-kubeconfig-mode: "644"
      tls-san:
        - "{{ k3s_vip }}"
  become: true

- name: Check if K3s is already installed
  ansible.builtin.stat:
    path: /usr/local/bin/k3s
  register: k3s_binary

- name: Download K3s install script
  ansible.builtin.get_url:
    url: https://get.k3s.io
    dest: /tmp/k3s-install.sh
    mode: "0755"
  when: not k3s_binary.stat.exists

# First server: bootstrap cluster
- name: Install K3s on first server
  ansible.builtin.shell: /tmp/k3s-install.sh
  args:
    creates: /usr/local/bin/k3s
  environment:
    INSTALL_K3S_EXEC: "{{ k3s_server_exec }}"
  become: true
  when: inventory_hostname == groups['k3s-dev'][0]

- name: Wait for K3s API server to be ready
  ansible.builtin.wait_for:
    port: 6443
    host: "{{ ansible_facts['default_ipv4']['address'] }}"
    timeout: 120
  when:
    - inventory_hostname == groups['k3s-dev'][0]
    - not ansible_check_mode

- name: Read K3s cluster token
  ansible.builtin.slurp:
    src: /var/lib/rancher/k3s/server/node-token
  register: k3s_token_raw
  become: true
  when:
    - inventory_hostname == groups['k3s-dev'][0]
    - not ansible_check_mode

- name: Set cluster token fact
  ansible.builtin.set_fact:
    k3s_cluster_token: "{{ k3s_token_raw.content | b64decode | trim }}"
  when:
    - inventory_hostname == groups['k3s-dev'][0]
    - not ansible_check_mode

# Additional servers: join cluster
- name: Join K3s cluster
  ansible.builtin.shell: /tmp/k3s-install.sh
  args:
    creates: /usr/local/bin/k3s
  environment:
    K3S_URL: "https://{{ hostvars[groups['k3s-dev'][0]].ansible_host }}:6443"
    K3S_TOKEN: "{{ hostvars[groups['k3s-dev'][0]].k3s_cluster_token | default('') }}"
    INSTALL_K3S_EXEC: "{{ k3s_server_exec }}"
  become: true
  when:
    - inventory_hostname != groups['k3s-dev'][0]
    - not ansible_check_mode